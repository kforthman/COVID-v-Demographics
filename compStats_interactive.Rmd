---
title: "compStats_interactive"
author: "Katie Forthman"
date: "`r date()`"
output: html_document
runtime: shiny
---

```{r}
#
#remove scientific notation
options(scipen=999)
```

```{r, include=FALSE}
# cd Data/COVID-19 ; git pull ; cd ../../
# compile
# git add compStats.html ; git commit -m "Updating data." ; git push origin master
# 
# 
```

# ---- Load packages ----

```{r}
library(stringr)
library(corrplot)
library(shiny)
library(lme4)
library(lmerTest)
library(gtools)
```

# ---- Load neighborhood data ----

```{r}

load("Data/county_factors.rda")
load("Data/county_500CitiesData.rda")

```


# ---- Load  and format covid data ----

```{r}
data.path <- "Data/COVID-19/csse_covid_19_data/csse_covid_19_time_series/"

# Read in the data
US.deaths <- read.csv(
  paste0(data.path, "time_series_covid19_deaths_US.csv"), 
  header = T, stringsAsFactors = F)
US.cases <- read.csv(
  paste0(data.path, "time_series_covid19_confirmed_US.csv"), 
  header = T, stringsAsFactors = F)

# Read in the header seprately.
US.cases.head <- read.csv(
  paste0(data.path, "time_series_covid19_confirmed_US.csv"), 
  header = F, stringsAsFactors = F)[1,]
US.deaths.head <- read.csv(
  paste0(data.path, "time_series_covid19_deaths_US.csv"), 
  header = F, stringsAsFactors = F)[1,]

# Correct the dates in the header to be more useable as
# column names.
proper_date <- function(dates){
  dates <- sapply(dates, strsplit, split = "/")
  dates <- lapply(dates, str_pad, width = 2, side = "left", pad = "0")
  dates <- lapply(dates, paste, collapse = "_")
  dates <- unlist(dates)
  
  return(dates)
}

dates.cases <- proper_date(US.cases.head[-c(1:11)])
dates.deaths <- proper_date(US.deaths.head[-c(1:12)])

names(US.cases) <- c(US.cases.head[1,1:11], dates.cases)
names(US.deaths) <- c(US.deaths.head[1,1:12], dates.deaths)

if(sum(US.cases$UID != US.deaths$UID, na.rm = T) > 0){warning("COVID data rows do not match!")}
US.cases$Population <- US.deaths$Population
US.cases <- US.cases[,c(1:11, ncol(US.cases), 12:(ncol(US.cases)-1))]
```

## Other stats within the daily reports
```{r}
data.path <- "Data/COVID-19/csse_covid_19_data/csse_covid_19_daily_reports_us/"
daily_filenames <- list.files(data.path)
daily_filenames <- daily_filenames[daily_filenames != "README.md"]

todays_report_filename <- daily_filenames[length(daily_filenames)]
US.todaysReport <- read.csv(
  paste0(data.path, todays_report_filename), 
  header = T, stringsAsFactors = F)
```

```{r}
all.states <- c('Alabama', 'Alaska', 'American Samoa', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware', 'Diamond Princess', 'District of Columbia', 'Florida', 'Georgia', 'Grand Princess', 'Guam', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Northern Mariana Islands', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Puerto Rico', 'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virgin Islands', 'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming')
all.states.df <- data.frame(Province_State = all.states)
all.stats <- c("Confirmed", "Deaths", "Recovered", "Active", "Incident_Rate", "People_Tested", "People_Hospitalized", "Mortality_Rate", "Testing_Rate", "Hospitalization_Rate")

compiled.stats <- list()
for(i in 1:length(daily_filenames)){
  day <- substring(daily_filenames[i],1,10)
  data <- read.csv(
    paste0(data.path, daily_filenames[i]),
    header = T, stringsAsFactors = F)
  compiled.stats[[i]] <- merge(all.states.df, data, all.y = F)
  names(compiled.stats)[i] <- day
}

```

## Functions for compiling and visualizing stats in the daily reports.
```{r}
plot.dailyStat <- function(state, stat){
  data <- sapply(1:length(daily_filenames), function(x){compiled.stats[[x]][compiled.stats[[x]]$Province_State == state, stat]})
  names(data) <- daily_filenames
  
  twoweek.col <- c(rep("grey", length(data) - 14), rep("pink", 14))
  
  barplot(data, col = twoweek.col, main = paste0(state, " ", stat), las = 2, cex.axis = 1, cex.names = 0.5, border = F)
}

plot.dailyStatRise <- function(state, stat){
  data <- sapply(1:length(daily_filenames), function(x){compiled.stats[[x]][compiled.stats[[x]]$Province_State == state, stat]})
  names(data) <- daily_filenames
  
  rise.stat <- matrix(ncol = length(data) - 1, nrow = 1)
  colnames(rise.stat) <- names(data)[-1]
  for(i in 1:ncol(rise.stat) + 1){
    rise <- data[i] - data[i-1]
    rise.stat[i-1] <- rise
  }
  
  twoweek.col <- c(rep("grey", length(rise.stat) - 14), rep("pink", 14))
  
  barplot(rise.stat[1,], col = twoweek.col, main = paste0(state, " rise in ",stat), las = 2, cex.axis = 1, cex.names = 0.5, border = F)
}

plot.dailyStatRise.avg <- function(state, stat, days = 7){
  data <- sapply(1:length(daily_filenames), function(x){compiled.stats[[x]][compiled.stats[[x]]$Province_State == state, stat]})
  names(data) <- daily_filenames
  
  rise.stat <- matrix(ncol = length(data) - 1, nrow = 1)
  colnames(rise.stat) <- names(data)[-1]
  for(i in 1:ncol(rise.stat) + 1){
    rise <- data[i] - data[i-1]
    rise.stat[i-1] <- rise
  }
  
    avg.rise.cases <- matrix(ncol = length(data) - 1, nrow = 1)
  colnames(avg.rise.cases) <- names(data)[-1]
  wind <- ifelse(even(days), days / 2, (days - 1) / 2)
  for(i in 1:ncol(avg.rise.cases)){
    beg.idx <- ifelse(i < 1 + wind, 1, i - wind)
    end.idx <- ifelse(i > ncol(avg.rise.cases) - wind, ncol(avg.rise.cases) , i + wind)
    avg.rise <- mean(rise.stat[beg.idx:end.idx])
    avg.rise.cases[i] <- avg.rise
  }
  
  twoweek.col <- c(rep("grey", length(avg.rise.cases) - 14), rep("pink", 14))
  
  barplot(avg.rise.cases[1,], col = twoweek.col,
          main = paste0(state, ", ", days, "-day rolling average rise in ",stat), 
          las = 2, cex.axis = 1, cex.names = 0.5, border = F)
}
```


```{r, fig.height=10}
testing.data.state <- compiled.stats[[length(daily_filenames)]][, c("Province_State", "Testing_Rate")]
testing.data.state <- testing.data.state[!is.na(testing.data.state$Testing_Rate),]
testing.data.state <- testing.data.state[order(testing.data.state$Testing_Rate),]

col.state <- rep("pink", nrow(testing.data.state))

avg.test.rate <- mean(testing.data.state$Testing_Rate, na.rm = T)

col.state[testing.data.state$Testing_Rate < avg.test.rate] <- "grey"
col.state[testing.data.state$Province_State == "Oklahoma"] <- "lightblue"

par(mar = c(5,6,4,2))
barplot(testing.data.state$Testing_Rate, names.arg = testing.data.state$Province_State, horiz = T, main = "Testing Rate by State", las = 2, cex.axis = 1, cex.names = 0.5, col = col.state, border = F, xlab = "Total number of people tested per 100,000 persons.")
abline(v = avg.test.rate, col = "red")
text(x = avg.test.rate + 10, y = 1, labels = "Average Testing Rate", adj = c(0, 0.5), col = "red")
```

## Interactive Plots
**Province_State** - The name of the State within the USA.
**Country_Region** - The name of the Country (US).
**Last_Update** - The most recent date the file was pushed.
**Lat** - Latitude.
**Long_** - Longitude.
**Confirmed** - Aggregated confirmed case count for the state.
**Deaths** - Aggregated Death case count for the state.
**Recovered** - Aggregated Recovered case count for the state.
**Active** - Aggregated confirmed cases that have not been resolved (Active = Confirmed - Recovered - Deaths).
**FIPS** - Federal Information Processing Standards code that uniquely identifies counties within the USA.
**Incident_Rate** - confirmed cases per 100,000 persons.
**People_Tested** - Total number of people who have been tested.
**People_Hospitalized** - Total number of people hospitalized.
**Mortality_Rate** - Number recorded deaths * 100/ Number confirmed cases.
**UID** - Unique Identifier for each row entry. 
**ISO3** - Officialy assigned country code identifiers.
**Testing_Rate** - Total number of people tested per 100,000 persons.
**Hospitalization_Rate** - Total number of people hospitalized * 100/ Number of confirmed cases.
```{r echo = FALSE}
selectInput("stat", "Select a statistic", choices = all.stats)
selectInput("state", "Select a state", choices = all.states)
selectInput("plot.type", "Select plot type", choices = c("Total", "Rise", "Rolling avg rise"))

renderPlot({
  if(input$plot.type == "Total"){
    plot.dailyStat(input$state, input$stat)
  }else if(input$plot.type == "Rise"){
    plot.dailyStatRise(input$state, input$stat)
  }else if(input$plot.type == "Rolling avg rise"){
    plot.dailyStatRise.avg(input$state, input$stat)
  }
})
```

## Split the dataset into the data and the info for usability.
```{r}
US.cases.info <- as.matrix(US.cases[,1:12])
US.cases.data <- as.matrix(US.cases[,-c(2:12)])
US.deaths.info <- as.matrix(US.deaths[,1:12])
US.deaths.data <- as.matrix(US.deaths[,-c(2:12)])

rownames(US.cases.info) <- US.cases.info[,1]
US.cases.info <- US.cases.info[,-1]
rownames(US.cases.data) <- US.cases.data[,1]
US.cases.data <- US.cases.data[,-1]
rownames(US.deaths.info) <- US.deaths.info[,1]
US.deaths.info <- US.deaths.info[,-1]
rownames(US.deaths.data) <- US.deaths.data[,1]
US.deaths.data <- US.deaths.data[,-1]


ndays.cases <- ncol(US.cases.data)
ndays.deaths <- ncol(US.deaths.data)

nobs <- nrow(US.cases.data)
```


# ---- The Curve ----

```{r}
state.curve <- function(state, stat = c("cases", "deaths"), logScale = T){
  if(stat == "cases"){
    data <- US.cases.data[which(US.cases$Province_State == state),]
  }else if(stat == "deaths"){
    data <- US.deaths.data[which(US.deaths$Province_State == state),]
  }
  data.sum <- colSums(data)
  day.first.case <- min(which(data.sum > 0))
  n.days <- length(data.sum)
  
  twoweek.col <- c(rep("grey", n.days-day.first.case-13), rep("pink", 14))
  
  if(logScale == T){
    barplot(data.sum[day.first.case:n.days], 
            main = paste0("Total COVID-19 ", stat," by date in ", state, ", log scale"), 
            log = "y", las = 2, cex.axis = 1, cex.names = 0.5, border = F, col = twoweek.col)
  }else{
    barplot(data.sum[day.first.case:n.days], 
            main = paste0("Total COVID-19 ", stat," by date in ", state), 
            las = 2, cex.axis = 1, cex.names = 0.5, border = F, col = twoweek.col)
  }
}
state.rise <- function(state, stat = c("cases", "deaths")){
  if(stat == "cases"){
    data.thisState <- US.cases.data[which(US.cases$Province_State == state),]
  }else if(stat == "deaths"){
    data.thisState <- US.deaths.data[which(US.deaths$Province_State == state),]
  }
  
  data.sum <- colSums(data.thisState)
  n.days <- ncol(data.thisState)
  
  rise.cases <- matrix(ncol = n.days - 1, nrow = 1)
  colnames(rise.cases) <- colnames(data.thisState)[-1]
  for(i in 1:ncol(rise.cases) + 1){
    rise <- data.sum[i] - data.sum[i-1]
    rise.cases[i-1] <- rise
  }
  
  day.first.case <- min(which(rise.cases > 0))
  n.days <- length(rise.cases)
  
  twoweek.col <- c(rep("grey", n.days-day.first.case-13), rep("pink", 14))
  
  barplot(rise.cases[,day.first.case:n.days], main = paste0("Rise in COVID-19 ", stat, " by Date in ", state), las = 2, cex.axis = 1, cex.names = 0.5, border = F, col = twoweek.col)
}
state.rise.avg <- function(state, stat = c("cases", "deaths"), days = 7){
  if(stat == "cases"){
    data.thisState <- US.cases.data[which(US.cases$Province_State == state),]
  }else if(stat == "deaths"){
    data.thisState <- US.deaths.data[which(US.deaths$Province_State == state),]
  }
  
  data.sum <- colSums(data.thisState)
  n.days <- ncol(data.thisState)
  
  rise.cases <- matrix(ncol = n.days - 1, nrow = 1)
  colnames(rise.cases) <- colnames(data.thisState)[-1]
  for(i in 1:ncol(rise.cases) + 1){
    rise <- data.sum[i] - data.sum[i-1]
    rise.cases[i-1] <- rise
  }
  
  avg.rise.cases <- matrix(ncol = n.days - 1, nrow = 1)
  colnames(avg.rise.cases) <- colnames(data.thisState)[-1]
  wind <- ifelse(even(days), days / 2, (days - 1) / 2)
  for(i in 1:ncol(avg.rise.cases)){
    beg.idx <- ifelse(i < 1 + wind, 1, i - wind)
    end.idx <- ifelse(i > ncol(avg.rise.cases) - wind, ncol(avg.rise.cases) , i + wind)
    avg.rise <- mean(rise.cases[beg.idx:end.idx])
    avg.rise.cases[i] <- avg.rise
  }
  
  day.first.case <- min(which(avg.rise.cases > 0))
  n.days <- length(avg.rise.cases)
  
  twoweek.col <- c(rep("grey", n.days-day.first.case-13), rep("pink", 14))
  
  barplot(avg.rise.cases[,day.first.case:n.days], main = paste0(days, " day rolling average Rise in COVID-19 ", stat, " by Date in ", state), las = 2, cex.axis = 1, cex.names = 0.5, col = twoweek.col, border = F)
}
```

```{r echo = FALSE}
selectInput("stat2", "Select a statistic", choices = c("cases", "deaths"))
selectInput("state2", "Select a state", choices = all.states)
selectInput("plot.type2", "Select plot type", choices = c("Total", "Total logarithmic", "Rise", "Rolling average rise"))
renderPlot({
  if(input$plot.type2 == "Total"){
    state.curve(input$state2, input$stat2, logScale = F)
  }else if(input$plot.type2 == "Total logarithmic"){
    state.curve(input$state2, input$stat2, logScale = T)
  }else if(input$plot.type2 == "Rise"){
    state.rise(input$state2, input$stat2)
  }else if(input$plot.type2 == "Rolling average rise"){
    state.rise.avg(input$state2, input$stat2, days = 7)
  }
})
```

```{r}
county.curve <- function(county, stat = c("cases", "deaths")){
  if(stat == "cases"){
    data <- US.cases.data[which(US.cases$Admin2 == county),]
  }else if(stat == "deaths"){
    data <- US.deaths.data[which(US.deaths$Admin2 == county),]
  }
  
  day.first.case <- min(which(data > 0))
  n.days <- length(data)
  
  barplot(data[day.first.case:n.days], main = paste0("Total COVID-19 ", stat," by date in ", county), log = "y", las = 2, cex.axis = 1, cex.names = 0.5)
  
}

county.curve("Tulsa", "cases")
county.curve("Tulsa", "deaths")
```


# ---- Calculate some useful stats to compare with neighborhood data ----

```{r}
US.stats <- data.frame(UID = US.cases$UID)
```

```{r}
cases.total <- colSums(US.cases.data)

day.first.case <- min(which(cases.total > 100))
n.days <- length(cases.total)

par(mar = c(5,5,4,2))
barplot(cases.total[day.first.case:n.days], main = "Total COVID-19 cases by Date in US", las = 2, cex.axis = 1, cex.names = 0.5)
barplot(cases.total[day.first.case:n.days], main = "Total COVID-19 cases by Date in US, log scale", las = 2, cex.axis = 1, cex.names = 0.5, log = "y")
```

```{r}
deaths.total <- colSums(US.deaths.data)

day.first.case <- min(which(deaths.total > 0))
n.days <- length(deaths.total)

barplot(deaths.total[day.first.case:n.days], main = "Total COVID-19 deaths by Date in US", las = 2, cex.axis = 1, cex.names = 0.5)
barplot(deaths.total[day.first.case:n.days], main = "Total COVID-19 deaths by Date in US, log scale", las = 2, cex.axis = 1, cex.names = 0.5, log = "y")
```

## Average rise in cases per day
avg.rise.cases
```{r}
rise.cases <- matrix(ncol = ndays.cases - 1, nrow = nobs)
colnames(rise.cases) <- colnames(US.cases.data)[-1]
for(i in 1:ncol(rise.cases) + 1){
  rise <- US.cases.data[,i] - US.cases.data[,i-1]
  rise.cases[,i-1] <- rise
}

US.stats$avg.rise.cases <- apply(rise.cases, 1, mean)

rise.cases.total <- colSums(rise.cases)

day.first.case <- min(which(rise.cases.total > 0))
n.days <- length(rise.cases.total)

barplot(rise.cases.total[day.first.case:n.days], main = "Rise in Cases of COVID-19 by Date in US", las = 2, cex.axis = 1, cex.names = 0.5)
```

## Average rise in deaths per day
avg.rise.deaths
```{r}
rise.deaths <- matrix(ncol = ndays.deaths - 1, nrow = nobs)
colnames(rise.deaths) <- colnames(US.deaths.data)[-1]
for(i in 1:ncol(rise.deaths) + 1){
  rise <- US.deaths.data[,i] - US.deaths.data[,i-1]
  rise.deaths[,i-1] <- rise
}

US.stats$avg.rise.deaths <- apply(rise.deaths, 1, mean)

rise.deaths.total <- colSums(rise.deaths)

day.first.case <- min(which(rise.deaths.total > 0))
n.days <- length(rise.deaths.total)

barplot(rise.deaths.total[day.first.case:n.days], main = "Rise in Deaths of COVID-19 by Date in US", las = 2, cex.axis = 1, cex.names = 0.5)
```

## Total cases
total.cases
```{r}
US.stats$total.cases <- US.cases.data[,ndays.cases]
```

## Total cases per capita
```{r}
US.stats$total.cases.percap <- US.stats$total.cases / US.cases$Population
US.stats$total.cases.percap[US.cases$Population == 0] <- NA
hist(US.stats$total.cases.percap)
```

## Total deaths
total.deaths
```{r}
US.stats$total.deaths <- US.deaths.data[,ndays.deaths]
```

## Total deaths per capita
total.deaths.percap
```{r}
US.stats$total.deaths.percap <- US.stats$total.deaths / US.deaths$Population
US.stats$total.deaths.percap[US.deaths$Population == 0] <- NA

max(US.stats$total.deaths.percap,na.rm = T)
```

## Total deaths per case
total.deaths.percase
*Error in Johns Hopkins data has rows with total.deaths > total.cases.*
```{r}
# pos.case.ind <- US.stats$total.cases > 0
# US.stats$total.deaths.percase[pos.case.ind] <- US.stats$total.deaths[pos.case.ind] / US.stats$total.cases[pos.case.ind]
# US.stats$total.deaths.percase[!pos.case.ind] <- 0
US.stats$total.deaths.percase <- US.stats$total.deaths / US.stats$total.cases
US.stats$total.deaths.percase[US.stats$total.cases == 0] <- NA

US.stats[which(US.stats$total.deaths > US.stats$total.cases),]

```


# ---- Merge COVID data with Neighborhood data ----

```{r}
US.stats$ID <- str_pad(US.stats$UID, 8, "left", pad = "0")
US.stats$ID <- substr(US.stats$ID, 4, 8)

data.merge <- merge(US.stats, county_factors, by = "ID")
```


# ---- Plot the relationships ----

```{r}
data.cor <- cor(data.merge[,-c(1:2)], use = "complete.obs", method = "spearman")
corrplot.mixed(data.cor, upper = 'ellipse', lower = 'number', tl.pos = 'lt', tl.cex = 1, lower.col = "black", number.cex = 0.5)
```

```{r}
data.merge2 <- merge(data.merge, county_500CitiesData, by = "ID", all.x = F)
```


# ---- Plot the relationships ----

```{r, fig.width=15, fig.height=15}
data.cor2 <- cor(data.merge2[,-c(1:2)], use = "complete.obs", method = "spearman")
corrplot.mixed(data.cor2, upper = 'ellipse', lower = 'number', tl.pos = 'lt', tl.cex = 1, lower.col = "black", number.cex = 0.5)
```

```{r, fig.height = 5, fig.width=5}
corrplot.mixed(data.cor2[1:7,8:42], upper = 'ellipse', lower = 'number', tl.pos = 'lt', tl.cex = 1, lower.col = "black", number.cex = 0.5)
```


# ----Linear Mixed Effects Model  ----

```{r}
US.todaysReport.states <- US.todaysReport[!is.na(US.todaysReport$FIPS) & nchar(US.todaysReport$FIPS)<=2,]
US.todaysReport.states$FIPS <- str_pad(US.todaysReport.states$FIPS, 2, "left", pad = "0")

data.merge2$stateID <- substr(data.merge2$ID,1,2)

data.merge3 <- merge(data.merge2, US.todaysReport.states, by.x = "stateID", by.y = "FIPS")

this.lme <- lmer("total.cases.percap ~ Affluence + Singletons.in.Tract + Seniors.in.Tract + African.Americans.in.Tract + Noncitizens.in.Tract + High.BP + Binge.Drinking + Cancer + Asthma + Heart.Disease + COPD + Smoking + Diabetes + No.Physical.Activity + Obesity + Poor.Sleeping.Habits + Poor.Mental.Health + Testing_Rate + Hospitalization_Rate + (1 | stateID)", data = data.merge3)

print(summary(this.lme), correlation=TRUE)

this.lme.sum <- summary(this.lme)

```


